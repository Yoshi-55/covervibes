
<% if @tracks.present? %>
    <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <% @tracks.each do |track| %>
                        <div x-data="{
                                open: false,
                                iframeKey: 0,
                                setTrackId(id) {
                                    const url = new URL(window.location);
                                    url.searchParams.set('trackid', id);
                                    window.history.pushState({}, '', url);
                                },
                                clearTrackId() {
                                    const url = new URL(window.location);
                                    url.searchParams.delete('trackid');
                                    window.history.pushState({}, '', url);
                                }
                            }" class="flex flex-col items-center">
                <% if track.album && track.album.images.any? %>
                    <img src="<%= track.album.images.first['url'] %>" alt="ジャケット画像"
                        class="object-cover rounded-box cursor-pointer mb-0 w-full max-w-xs aspect-square"
                        style="max-width:400px;"
                        @click="open = true; setTrackId('<%= track.id %>')"
                        :class="(document.documentElement.getAttribute('data-theme') === 'black') ? 'grayscale' : ''"
                    />
                    <!-- Modal -->
                    <dialog :open="open" class="modal" @close="iframeKey++; clearTrackId()">
                        <form method="dialog" class="modal-backdrop" @click="open = false; iframeKey++; clearTrackId()">
                            <button>close</button>
                        </form>
                        <div class="modal-box w-full max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl p-4 relative">
                            <button @click="open = false; iframeKey++; clearTrackId()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
                            <img src="<%= track.album.images.first['url'] %>" alt="ジャケット画像"
                                class="object-contain mx-auto w-full max-w-xs sm:max-w-md md:max-w-lg lg:max-w-[400px] aspect-square"
                                :class="(document.documentElement.getAttribute('data-theme') === 'black') ? 'grayscale' : ''"
                            />
                            <div class="text-center mt-4 space-y-1">
                                <div class="text-lg font-bold text-primary">
                                    <%= track.name %>
                                </div>
                                <div class="text-base text-secondary">
                                    <%= track.artists.map(&:name).join(', ') %>
                                </div>
                                <div class="text-sm text-accent">
                                    <a href="<%= track.album.external_urls['spotify'] %>" target="_blank" rel="noopener" class="link link-hover">
                                        <%= track.album.name %>
                                    </a>
                                </div>
                            </div>
                            <% if track.external_urls['spotify'] %>
                                <div class="mt-4 flex justify-center">
                                    <template x-if="open">
                                        <iframe :key="iframeKey" src="https://open.spotify.com/embed/track/<%= track.id %>"
                                            class="rounded-2xl w-full max-w-xs sm:max-w-md md:max-w-lg lg:max-w-[400px]"
                                            style="height:80px;" frameborder="0" allowtransparency="true"
                                            allow="encrypted-media"
                                            :class="(document.documentElement.getAttribute('data-theme') === 'black') ? 'grayscale' : ''"></iframe>
                                    </template>
                                </div>
                            <% end %>
                            <div class="mt-4 flex justify-center">
                                <%= render 'shared/x_share_button', track: track %>
                            </div>
                        </div>
                    </dialog>
                <% end %>
            </div>
        <% end %>
    </div>

<% else %>
        <p>曲が取得できませんでした。</p>
<% end %>

<div class="mt-20 flex justify-center">
    <div class="card w-full max-w-md bg-base-200 shadow-xl">
        <div class="card-body items-center text-center">
            <h2 class="card-title text-primary">How to Use</h2>
            <p class="text-base text-gray-500">←サイドバーからジャンルを選んで曲を探そう。<br>画像クリックで詳細、試聴ができます。</p>
        </div>
    </div>
</div>
